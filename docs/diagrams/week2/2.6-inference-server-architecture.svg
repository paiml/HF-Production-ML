<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1920 1080">
  <defs>
    <linearGradient id="serverGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#22c55e"/>
      <stop offset="100%" stop-color="#16a34a"/>
    </linearGradient>
    <linearGradient id="batchGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#8b5cf6"/>
      <stop offset="100%" stop-color="#6d28d9"/>
    </linearGradient>
    <linearGradient id="gpuGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#f59e0b"/>
      <stop offset="100%" stop-color="#d97706"/>
    </linearGradient>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#64748b"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#22c55e"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1920" height="1080" fill="#020617"/>

  <!-- Title -->
  <text x="960" y="50" text-anchor="middle" fill="#f8fafc" font-family="Inter, system-ui, sans-serif" font-size="36" font-weight="700">2.6 Inference Server Architecture</text>
  <text x="960" y="85" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="16">apr serve: Load Balancing, Batching, and Scaling</text>

  <!-- Client Requests (Left) -->
  <g transform="translate(120, 400)">
    <text x="0" y="-180" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="14">Clients</text>

    <rect x="-60" y="-150" width="120" height="60" rx="8" fill="#1e293b" stroke="#64748b" stroke-width="2"/>
    <text x="0" y="-115" text-anchor="middle" fill="#94a3b8" font-family="Inter, system-ui, sans-serif" font-size="11">Request 1</text>

    <rect x="-60" y="-80" width="120" height="60" rx="8" fill="#1e293b" stroke="#64748b" stroke-width="2"/>
    <text x="0" y="-45" text-anchor="middle" fill="#94a3b8" font-family="Inter, system-ui, sans-serif" font-size="11">Request 2</text>

    <rect x="-60" y="-10" width="120" height="60" rx="8" fill="#1e293b" stroke="#64748b" stroke-width="2"/>
    <text x="0" y="25" text-anchor="middle" fill="#94a3b8" font-family="Inter, system-ui, sans-serif" font-size="11">Request 3</text>

    <rect x="-60" y="60" width="120" height="60" rx="8" fill="#1e293b" stroke="#64748b" stroke-width="2"/>
    <text x="0" y="95" text-anchor="middle" fill="#94a3b8" font-family="Inter, system-ui, sans-serif" font-size="11">Request N</text>

    <!-- Dots -->
    <text x="0" y="150" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="20">...</text>
  </g>

  <!-- Arrows to Load Balancer -->
  <line x1="185" y1="280" x2="295" y2="340" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="185" y1="350" x2="295" y2="370" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="185" y1="420" x2="295" y2="400" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="185" y1="490" x2="295" y2="460" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Load Balancer -->
  <g transform="translate(400, 400)">
    <rect x="-100" y="-150" width="200" height="300" rx="16" fill="#0f172a" stroke="#3b82f6" stroke-width="3"/>
    <text x="0" y="-115" text-anchor="middle" fill="#60a5fa" font-family="Inter, system-ui, sans-serif" font-size="16" font-weight="700">Load Balancer</text>

    <rect x="-80" y="-80" width="160" height="50" rx="6" fill="#1e3a5f"/>
    <text x="0" y="-50" text-anchor="middle" fill="#93c5fd" font-family="Inter, system-ui, sans-serif" font-size="11">Health Checks</text>

    <rect x="-80" y="-20" width="160" height="50" rx="6" fill="#1e3a5f"/>
    <text x="0" y="10" text-anchor="middle" fill="#93c5fd" font-family="Inter, system-ui, sans-serif" font-size="11">Round Robin</text>

    <rect x="-80" y="40" width="160" height="50" rx="6" fill="#1e3a5f"/>
    <text x="0" y="70" text-anchor="middle" fill="#93c5fd" font-family="Inter, system-ui, sans-serif" font-size="11">Queue Management</text>
  </g>

  <!-- Arrows to Request Queue -->
  <line x1="505" y1="400" x2="595" y2="400" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Request Queue -->
  <g transform="translate(700, 400)">
    <rect x="-100" y="-150" width="200" height="300" rx="16" fill="#0f172a" stroke="#8b5cf6" stroke-width="3"/>
    <rect x="-90" y="-140" width="180" height="280" rx="12" fill="url(#batchGrad)" opacity="0.1"/>
    <text x="0" y="-115" text-anchor="middle" fill="#a78bfa" font-family="Inter, system-ui, sans-serif" font-size="16" font-weight="700">Request Queue</text>

    <!-- Queue items -->
    <rect x="-80" y="-80" width="160" height="35" rx="4" fill="#2e1065"/>
    <text x="0" y="-58" text-anchor="middle" fill="#c4b5fd" font-family="JetBrains Mono, monospace" font-size="10">req_001 [waiting]</text>

    <rect x="-80" y="-40" width="160" height="35" rx="4" fill="#2e1065"/>
    <text x="0" y="-18" text-anchor="middle" fill="#c4b5fd" font-family="JetBrains Mono, monospace" font-size="10">req_002 [waiting]</text>

    <rect x="-80" y="0" width="160" height="35" rx="4" fill="#2e1065"/>
    <text x="0" y="22" text-anchor="middle" fill="#c4b5fd" font-family="JetBrains Mono, monospace" font-size="10">req_003 [waiting]</text>

    <rect x="-80" y="40" width="160" height="35" rx="4" fill="#8b5cf6" opacity="0.5"/>
    <text x="0" y="62" text-anchor="middle" fill="#e9d5ff" font-family="JetBrains Mono, monospace" font-size="10">batch forming...</text>

    <text x="0" y="110" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="11">Continuous Batching</text>
  </g>

  <!-- Arrows to Batch Scheduler -->
  <line x1="805" y1="400" x2="895" y2="400" stroke="#8b5cf6" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Batch Scheduler -->
  <g transform="translate(1000, 400)">
    <rect x="-100" y="-150" width="200" height="300" rx="16" fill="#0f172a" stroke="#f59e0b" stroke-width="3"/>
    <rect x="-90" y="-140" width="180" height="280" rx="12" fill="url(#gpuGrad)" opacity="0.1"/>
    <text x="0" y="-115" text-anchor="middle" fill="#fbbf24" font-family="Inter, system-ui, sans-serif" font-size="16" font-weight="700">Batch Scheduler</text>

    <rect x="-80" y="-80" width="160" height="60" rx="6" fill="#451a03"/>
    <text x="0" y="-55" text-anchor="middle" fill="#fcd34d" font-family="Inter, system-ui, sans-serif" font-size="11">Dynamic Batching</text>
    <text x="0" y="-35" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="9">max_batch=32</text>

    <rect x="-80" y="-10" width="160" height="60" rx="6" fill="#451a03"/>
    <text x="0" y="15" text-anchor="middle" fill="#fcd34d" font-family="Inter, system-ui, sans-serif" font-size="11">Padding Strategy</text>
    <text x="0" y="35" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="9">min waste</text>

    <rect x="-80" y="60" width="160" height="60" rx="6" fill="#451a03"/>
    <text x="0" y="85" text-anchor="middle" fill="#fcd34d" font-family="Inter, system-ui, sans-serif" font-size="11">Priority Queue</text>
    <text x="0" y="105" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="9">SLA aware</text>
  </g>

  <!-- Arrows to GPU Pool -->
  <line x1="1105" y1="400" x2="1195" y2="400" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- GPU Memory Pool -->
  <g transform="translate(1350, 400)">
    <rect x="-150" y="-150" width="300" height="300" rx="16" fill="#0f172a" stroke="#22c55e" stroke-width="3"/>
    <rect x="-140" y="-140" width="280" height="280" rx="12" fill="url(#serverGrad)" opacity="0.1"/>
    <text x="0" y="-115" text-anchor="middle" fill="#4ade80" font-family="Inter, system-ui, sans-serif" font-size="16" font-weight="700">GPU Memory Pool</text>

    <!-- GPU boxes -->
    <g transform="translate(-70, -40)">
      <rect x="-50" y="-40" width="100" height="80" rx="8" fill="#052e16" stroke="#22c55e" stroke-width="2"/>
      <text x="0" y="-15" text-anchor="middle" fill="#4ade80" font-family="Inter, system-ui, sans-serif" font-size="12" font-weight="600">GPU 0</text>
      <text x="0" y="5" text-anchor="middle" fill="#64748b" font-family="JetBrains Mono, monospace" font-size="9">RTX 4090</text>
      <rect x="-40" y="15" width="80" height="12" rx="2" fill="#1e293b"/>
      <rect x="-40" y="15" width="60" height="12" rx="2" fill="#22c55e" opacity="0.7"/>
    </g>

    <g transform="translate(70, -40)">
      <rect x="-50" y="-40" width="100" height="80" rx="8" fill="#052e16" stroke="#22c55e" stroke-width="2"/>
      <text x="0" y="-15" text-anchor="middle" fill="#4ade80" font-family="Inter, system-ui, sans-serif" font-size="12" font-weight="600">GPU 1</text>
      <text x="0" y="5" text-anchor="middle" fill="#64748b" font-family="JetBrains Mono, monospace" font-size="9">RTX 4090</text>
      <rect x="-40" y="15" width="80" height="12" rx="2" fill="#1e293b"/>
      <rect x="-40" y="15" width="40" height="12" rx="2" fill="#22c55e" opacity="0.7"/>
    </g>

    <!-- KV Cache -->
    <rect x="-120" y="60" width="240" height="60" rx="6" fill="#1e293b"/>
    <text x="0" y="85" text-anchor="middle" fill="#86efac" font-family="Inter, system-ui, sans-serif" font-size="11">KV Cache Pool</text>
    <text x="0" y="105" text-anchor="middle" fill="#64748b" font-family="JetBrains Mono, monospace" font-size="9">PagedAttention blocks</text>
  </g>

  <!-- Arrows to Response -->
  <line x1="1505" y1="400" x2="1595" y2="400" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>

  <!-- Response -->
  <g transform="translate(1760, 400)">
    <rect x="-140" y="-150" width="280" height="300" rx="16" fill="#0f172a" stroke="#22c55e" stroke-width="3"/>
    <text x="0" y="-115" text-anchor="middle" fill="#4ade80" font-family="Inter, system-ui, sans-serif" font-size="16" font-weight="700">Response</text>

    <rect x="-120" y="-80" width="240" height="100" rx="8" fill="#1e293b"/>
    <text x="0" y="-55" text-anchor="middle" fill="#86efac" font-family="JetBrains Mono, monospace" font-size="10">POST /v1/chat/completions</text>
    <text x="0" y="-30" text-anchor="middle" fill="#64748b" font-family="JetBrains Mono, monospace" font-size="9">HTTP 200</text>
    <rect x="-100" y="-15" width="200" height="30" rx="4" fill="#052e16"/>
    <text x="0" y="5" text-anchor="middle" fill="#4ade80" font-family="JetBrains Mono, monospace" font-size="9">streaming: true</text>

    <rect x="-120" y="40" width="240" height="80" rx="8" fill="#1e293b"/>
    <text x="0" y="65" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="10">OpenAI Compatible</text>
    <text x="0" y="85" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="10">SSE tokens</text>
    <text x="0" y="105" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="10">usage stats</text>
  </g>

  <!-- Bottom: Endpoints -->
  <g transform="translate(960, 900)">
    <rect x="-800" y="-80" width="1600" height="130" rx="12" fill="#0f172a" stroke="#334155" stroke-width="2"/>
    <text x="0" y="-50" text-anchor="middle" fill="#e2e8f0" font-family="Inter, system-ui, sans-serif" font-size="16" font-weight="600">API Endpoints</text>

    <g transform="translate(-500, 10)">
      <rect x="-130" y="-30" width="260" height="60" rx="6" fill="#1e293b" stroke="#22c55e" stroke-width="1"/>
      <text x="0" y="-5" text-anchor="middle" fill="#4ade80" font-family="JetBrains Mono, monospace" font-size="11">POST /v1/chat/completions</text>
      <text x="0" y="15" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="10">Chat inference</text>
    </g>

    <g transform="translate(-150, 10)">
      <rect x="-130" y="-30" width="260" height="60" rx="6" fill="#1e293b" stroke="#3b82f6" stroke-width="1"/>
      <text x="0" y="-5" text-anchor="middle" fill="#60a5fa" font-family="JetBrains Mono, monospace" font-size="11">POST /v1/completions</text>
      <text x="0" y="15" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="10">Text completion</text>
    </g>

    <g transform="translate(200, 10)">
      <rect x="-130" y="-30" width="260" height="60" rx="6" fill="#1e293b" stroke="#f59e0b" stroke-width="1"/>
      <text x="0" y="-5" text-anchor="middle" fill="#fbbf24" font-family="JetBrains Mono, monospace" font-size="11">GET /health</text>
      <text x="0" y="15" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="10">Readiness probe</text>
    </g>

    <g transform="translate(550, 10)">
      <rect x="-130" y="-30" width="260" height="60" rx="6" fill="#1e293b" stroke="#8b5cf6" stroke-width="1"/>
      <text x="0" y="-5" text-anchor="middle" fill="#a78bfa" font-family="JetBrains Mono, monospace" font-size="11">GET /metrics</text>
      <text x="0" y="15" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="10">Prometheus format</text>
    </g>
  </g>

  <!-- Footer -->
  <text x="960" y="1060" text-anchor="middle" fill="#475569" font-family="Inter, system-ui, sans-serif" font-size="14">apr serve: Request Flow from Client to GPU to Response</text>
</svg>
