<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1920 1080">
  <defs>
    <linearGradient id="corpusGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#3b82f6"/>
      <stop offset="100%" stop-color="#1d4ed8"/>
    </linearGradient>
    <linearGradient id="transpileGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#8b5cf6"/>
      <stop offset="100%" stop-color="#6d28d9"/>
    </linearGradient>
    <linearGradient id="compileGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#f59e0b"/>
      <stop offset="100%" stop-color="#d97706"/>
    </linearGradient>
    <linearGradient id="oracleGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#22c55e"/>
      <stop offset="100%" stop-color="#16a34a"/>
    </linearGradient>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#64748b"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#22c55e"/>
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#ef4444"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1920" height="1080" fill="#020617"/>

  <!-- Title -->
  <text x="960" y="50" text-anchor="middle" fill="#f8fafc" font-family="Inter, system-ui, sans-serif" font-size="36" font-weight="700">2.10 Compiler-in-the-Loop (CITL) Training</text>
  <text x="960" y="85" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="16">Using Compiler Feedback to Improve ML Models</text>

  <!-- Main Loop Visualization -->
  <!-- Step 1: Corpus -->
  <g transform="translate(300, 350)">
    <rect x="-160" y="-130" width="320" height="260" rx="20" fill="#0f172a" stroke="#3b82f6" stroke-width="3"/>
    <rect x="-150" y="-120" width="300" height="240" rx="16" fill="url(#corpusGrad)" opacity="0.1"/>

    <circle cx="0" cy="-80" r="30" fill="#1e3a5f" stroke="#3b82f6" stroke-width="2"/>
    <text x="0" y="-75" text-anchor="middle" fill="#60a5fa" font-family="Inter, system-ui, sans-serif" font-size="20" font-weight="700">1</text>

    <text x="0" y="-30" text-anchor="middle" fill="#60a5fa" font-family="Inter, system-ui, sans-serif" font-size="20" font-weight="700">CORPUS</text>

    <!-- Python files -->
    <g transform="translate(0, 30)">
      <rect x="-120" y="-30" width="80" height="90" rx="6" fill="#1e3a5f"/>
      <text x="-80" y="-5" text-anchor="middle" fill="#60a5fa" font-family="JetBrains Mono, monospace" font-size="9">.py</text>
      <text x="-80" y="15" text-anchor="middle" fill="#93c5fd" font-family="JetBrains Mono, monospace" font-size="8">async</text>
      <text x="-80" y="30" text-anchor="middle" fill="#93c5fd" font-family="JetBrains Mono, monospace" font-size="8">cli</text>
      <text x="-80" y="45" text-anchor="middle" fill="#93c5fd" font-family="JetBrains Mono, monospace" font-size="8">data</text>

      <rect x="-30" y="-30" width="80" height="90" rx="6" fill="#1e3a5f"/>
      <text x="10" y="-5" text-anchor="middle" fill="#60a5fa" font-family="JetBrains Mono, monospace" font-size="9">.rs</text>
      <text x="10" y="15" text-anchor="middle" fill="#93c5fd" font-family="JetBrains Mono, monospace" font-size="8">pairs</text>
      <text x="10" y="30" text-anchor="middle" fill="#93c5fd" font-family="JetBrains Mono, monospace" font-size="8">606</text>
      <text x="10" y="45" text-anchor="middle" fill="#93c5fd" font-family="JetBrains Mono, monospace" font-size="8">total</text>

      <rect x="60" y="-30" width="80" height="90" rx="6" fill="#1e3a5f"/>
      <text x="100" y="5" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="9">HuggingFace</text>
      <text x="100" y="25" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="9">Dataset</text>
    </g>
  </g>

  <!-- Arrow 1->2 -->
  <line x1="465" y1="350" x2="575" y2="350" stroke="#64748b" stroke-width="3" marker-end="url(#arrow)"/>
  <text x="520" y="335" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="11">load</text>

  <!-- Step 2: Transpile -->
  <g transform="translate(700, 350)">
    <rect x="-120" y="-130" width="240" height="260" rx="20" fill="#0f172a" stroke="#8b5cf6" stroke-width="3"/>
    <rect x="-110" y="-120" width="220" height="240" rx="16" fill="url(#transpileGrad)" opacity="0.1"/>

    <circle cx="0" cy="-80" r="30" fill="#2e1065" stroke="#8b5cf6" stroke-width="2"/>
    <text x="0" y="-75" text-anchor="middle" fill="#a78bfa" font-family="Inter, system-ui, sans-serif" font-size="20" font-weight="700">2</text>

    <text x="0" y="-30" text-anchor="middle" fill="#a78bfa" font-family="Inter, system-ui, sans-serif" font-size="20" font-weight="700">TRANSPILE</text>

    <rect x="-90" y="0" width="180" height="40" rx="6" fill="#2e1065"/>
    <text x="0" y="25" text-anchor="middle" fill="#c4b5fd" font-family="Inter, system-ui, sans-serif" font-size="11">AST Parsing</text>

    <rect x="-90" y="50" width="180" height="40" rx="6" fill="#2e1065"/>
    <text x="0" y="75" text-anchor="middle" fill="#c4b5fd" font-family="Inter, system-ui, sans-serif" font-size="11">Type Inference</text>

    <text x="0" y="115" text-anchor="middle" fill="#64748b" font-family="JetBrains Mono, monospace" font-size="10">depyler transpile</text>
  </g>

  <!-- Arrow 2->3 -->
  <line x1="825" y1="350" x2="935" y2="350" stroke="#64748b" stroke-width="3" marker-end="url(#arrow)"/>
  <text x="880" y="335" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="11">.rs</text>

  <!-- Step 3: Compile -->
  <g transform="translate(1060, 350)">
    <rect x="-120" y="-130" width="240" height="260" rx="20" fill="#0f172a" stroke="#f59e0b" stroke-width="3"/>
    <rect x="-110" y="-120" width="220" height="240" rx="16" fill="url(#compileGrad)" opacity="0.1"/>

    <circle cx="0" cy="-80" r="30" fill="#451a03" stroke="#f59e0b" stroke-width="2"/>
    <text x="0" y="-75" text-anchor="middle" fill="#fbbf24" font-family="Inter, system-ui, sans-serif" font-size="20" font-weight="700">3</text>

    <text x="0" y="-30" text-anchor="middle" fill="#fbbf24" font-family="Inter, system-ui, sans-serif" font-size="20" font-weight="700">COMPILE</text>

    <rect x="-90" y="0" width="180" height="40" rx="6" fill="#451a03"/>
    <text x="0" y="25" text-anchor="middle" fill="#fcd34d" font-family="JetBrains Mono, monospace" font-size="11">rustc</text>

    <!-- Success/Fail split -->
    <g transform="translate(-45, 80)">
      <rect x="-35" y="-20" width="70" height="40" rx="4" fill="#052e16" stroke="#22c55e" stroke-width="1"/>
      <text x="0" y="5" text-anchor="middle" fill="#4ade80" font-family="Inter, system-ui, sans-serif" font-size="10">OK</text>
    </g>

    <g transform="translate(45, 80)">
      <rect x="-35" y="-20" width="70" height="40" rx="4" fill="#450a0a" stroke="#ef4444" stroke-width="1"/>
      <text x="0" y="5" text-anchor="middle" fill="#f87171" font-family="Inter, system-ui, sans-serif" font-size="10">Error</text>
    </g>
  </g>

  <!-- Arrow 3->4 (error path) -->
  <path d="M 1105 485 Q 1105 600 1200 650" stroke="#ef4444" stroke-width="3" fill="none" marker-end="url(#arrowRed)"/>
  <text x="1080" y="580" fill="#f87171" font-family="Inter, system-ui, sans-serif" font-size="11">errors</text>

  <!-- Step 4: Classify -->
  <g transform="translate(1320, 700)">
    <rect x="-120" y="-80" width="240" height="160" rx="16" fill="#0f172a" stroke="#ef4444" stroke-width="3"/>

    <text x="0" y="-45" text-anchor="middle" fill="#f87171" font-family="Inter, system-ui, sans-serif" font-size="16" font-weight="700">CLASSIFY</text>

    <!-- Error categories -->
    <g transform="translate(0, 10)">
      <rect x="-100" y="-25" width="90" height="30" rx="4" fill="#450a0a"/>
      <text x="-55" y="-5" text-anchor="middle" fill="#fca5a5" font-family="JetBrains Mono, monospace" font-size="8">E0308</text>

      <rect x="0" y="-25" width="90" height="30" rx="4" fill="#450a0a"/>
      <text x="45" y="-5" text-anchor="middle" fill="#fca5a5" font-family="JetBrains Mono, monospace" font-size="8">E0382</text>

      <rect x="-100" y="15" width="90" height="30" rx="4" fill="#450a0a"/>
      <text x="-55" y="35" text-anchor="middle" fill="#fca5a5" font-family="JetBrains Mono, monospace" font-size="8">E0433</text>

      <rect x="0" y="15" width="90" height="30" rx="4" fill="#450a0a"/>
      <text x="45" y="35" text-anchor="middle" fill="#fca5a5" font-family="JetBrains Mono, monospace" font-size="8">E0597</text>
    </g>
  </g>

  <!-- Arrow 4->5 -->
  <line x1="1320" y1="615" x2="1320" y2="525" stroke="#64748b" stroke-width="3" marker-end="url(#arrow)"/>
  <text x="1355" y="570" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="11">patterns</text>

  <!-- Step 5: Oracle -->
  <g transform="translate(1560, 350)">
    <rect x="-200" y="-130" width="400" height="260" rx="20" fill="#0f172a" stroke="#22c55e" stroke-width="3"/>
    <rect x="-190" y="-120" width="380" height="240" rx="16" fill="url(#oracleGrad)" opacity="0.1"/>

    <circle cx="0" cy="-80" r="30" fill="#052e16" stroke="#22c55e" stroke-width="2"/>
    <text x="0" y="-75" text-anchor="middle" fill="#4ade80" font-family="Inter, system-ui, sans-serif" font-size="20" font-weight="700">4</text>

    <text x="0" y="-30" text-anchor="middle" fill="#4ade80" font-family="Inter, system-ui, sans-serif" font-size="20" font-weight="700">ORACLE</text>

    <!-- Oracle internals -->
    <rect x="-170" y="0" width="160" height="100" rx="8" fill="#052e16"/>
    <text x="-90" y="25" text-anchor="middle" fill="#86efac" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600">Random Forest</text>
    <text x="-90" y="45" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="9">100 trees</text>
    <text x="-90" y="62" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="9">7 error classes</text>
    <text x="-90" y="79" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="9">fix patterns</text>

    <rect x="10" y="0" width="160" height="100" rx="8" fill="#052e16"/>
    <text x="90" y="25" text-anchor="middle" fill="#86efac" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600">N-gram Predictor</text>
    <text x="90" y="45" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="9">error → fix</text>
    <text x="90" y="62" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="9">success rate</text>
    <text x="90" y="79" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="9">incremental</text>

    <text x="0" y="120" text-anchor="middle" fill="#64748b" font-family="JetBrains Mono, monospace" font-size="10">oracle.apr → HuggingFace</text>
  </g>

  <!-- Feedback loop arrow (Oracle back to Transpile) -->
  <path d="M 1360 280 Q 1060 120 700 220" stroke="#22c55e" stroke-width="3" stroke-dasharray="10,5" fill="none" marker-end="url(#arrowGreen)"/>
  <text x="1060" y="140" text-anchor="middle" fill="#4ade80" font-family="Inter, system-ui, sans-serif" font-size="12" font-weight="600">Feedback Loop</text>
  <text x="1060" y="160" text-anchor="middle" fill="#86efac" font-family="Inter, system-ui, sans-serif" font-size="10">improved patterns</text>

  <!-- Bottom: Metrics -->
  <g transform="translate(960, 900)">
    <rect x="-800" y="-100" width="1600" height="160" rx="16" fill="#0f172a" stroke="#334155" stroke-width="2"/>
    <text x="0" y="-65" text-anchor="middle" fill="#e2e8f0" font-family="Inter, system-ui, sans-serif" font-size="18" font-weight="600">CITL Training Results</text>

    <!-- Metrics boxes -->
    <g transform="translate(-550, 10)">
      <rect x="-140" y="-40" width="280" height="90" rx="8" fill="#1e293b"/>
      <text x="0" y="-15" text-anchor="middle" fill="#60a5fa" font-family="Inter, system-ui, sans-serif" font-size="14" font-weight="600">Initial Corpus</text>
      <text x="0" y="10" text-anchor="middle" fill="#93c5fd" font-family="Inter, system-ui, sans-serif" font-size="12">606 Python-Rust pairs</text>
      <text x="0" y="30" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="10">~40% single-shot compile</text>
    </g>

    <g transform="translate(0, 10)">
      <rect x="-140" y="-40" width="280" height="90" rx="8" fill="#1e293b"/>
      <text x="0" y="-15" text-anchor="middle" fill="#a78bfa" font-family="Inter, system-ui, sans-serif" font-size="14" font-weight="600">After CITL Training</text>
      <text x="0" y="10" text-anchor="middle" fill="#c4b5fd" font-family="Inter, system-ui, sans-serif" font-size="12">Oracle learns fix patterns</text>
      <text x="0" y="30" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="10">Project-specific idioms</text>
    </g>

    <g transform="translate(550, 10)">
      <rect x="-140" y="-40" width="280" height="90" rx="8" fill="#052e16" stroke="#22c55e" stroke-width="1"/>
      <text x="0" y="-15" text-anchor="middle" fill="#4ade80" font-family="Inter, system-ui, sans-serif" font-size="14" font-weight="600">Result</text>
      <text x="0" y="10" text-anchor="middle" fill="#86efac" font-family="Inter, system-ui, sans-serif" font-size="12">~80% single-shot compile</text>
      <text x="0" y="30" text-anchor="middle" fill="#64748b" font-family="Inter, system-ui, sans-serif" font-size="10">2x improvement from feedback</text>
    </g>
  </g>

  <!-- Footer -->
  <text x="960" y="1060" text-anchor="middle" fill="#475569" font-family="Inter, system-ui, sans-serif" font-size="14">CITL: Compiler feedback trains Oracle to predict and fix transpilation errors</text>
</svg>
